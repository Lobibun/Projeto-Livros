@using LivroCDF.Models.Enums
@model LivroCDF.Models.Cliente

@{
    ViewData["Title"] = "Detalhes";
}

<h1>Detalhes do Cliente</h1>

<div>
    <hr />
    <dl class="row">
        <dt class="col-sm-2">@Html.DisplayNameFor(model => model.Nome)</dt>
        <dd class="col-sm-10">@Html.DisplayFor(model => model.Nome)</dd>

        <dt class="col-sm-2">@Html.DisplayNameFor(model => model.Email)</dt>
        <dd class="col-sm-10">@Html.DisplayFor(model => model.Email)</dd>
    </dl>
</div>

<hr />
<h3>Histórico de Compras / Pendências</h3>

@if (Model.Compras != null && Model.Compras.Any())
{
    <table class="table table-hover">
        <thead>
            <tr>
                <th>Livro</th>
                <th>Data da Venda</th> @* Mudamos o nome para ficar mais claro *@
                <th>Valor</th>
                <th class="text-center">Status</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var item in Model.Compras)
            {
                // LÓGICA CORRIGIDA:
                // É pendente se o Status for 'APagar', independente da data.
                bool estaPendente = item.Status == StatusLivro.APagar;

                // Se for pendente, pinta a linha de amarelo
                string classeCss = estaPendente ? "table-warning fw-bold" : "";

                <tr class="@classeCss">
                    <td>
                        @item.Livro?.Titulo
                        @if (estaPendente)
                        {
                            // Um ícone de alerta extra para chamar atenção
                            <span class="text-danger ms-2" title="Débito em aberto">
                                <i class="bi bi-exclamation-circle-fill"></i>
                            </span>
                        }
                    </td>

                    @* MOSTRAR A DATA SEMPRE (Seja venda paga ou fiado) *@
                    <td>
                        @if (item.DataVenda.HasValue)
                        {
                            <span class="text-dark">
                                <i class="bi bi-calendar-event"></i> @item.DataVenda.Value.ToString("dd/MM/yyyy")
                            </span>

                            @* Se for A Pagar, mostra quantos dias faz *@
                            @if (item.Status == LivroCDF.Models.Enums.StatusLivro.APagar)
                            {
                                var dias = (DateTime.Now - item.DataVenda.Value).Days;
                                if (dias > 0)
                                {
                                    <br />
                
                                    <small class="text-danger fw-bold">(@dias dias atrás)</small>
                                }
                                else
                                {
                                    <br />
                
                                    <small class="text-danger fw-bold">(Hoje)</small>
                                }
                            }
                        }
                        else
                        {
                            <span>-</span>
                        }
                    </td>

                    <td>@item.Valor.ToString("C2")</td>

                    <td class="text-center">
                        @switch (item.Status)
                        {
                            case LivroCDF.Models.Enums.StatusLivro.APagar:
                                <span class="badge bg-danger">Aguardando Pagamento</span>
                                break;

                            case LivroCDF.Models.Enums.StatusLivro.Vendido:
                                <span class="badge bg-success">Venda Concluída</span>
                                break;

                            case LivroCDF.Models.Enums.StatusLivro.Estoque:
                               
                                <span class="badge bg-secondary text-decoration-line-through">Estornado / Devolvido</span>
                                break;

                            default:
                                @item.Status
                                break;
                        }
                    </td>
                </tr>
            }
        </tbody>
    </table>
}
else
{
    <div class="alert alert-info">
        <i class="bi bi-info-circle"></i> Nenhuma movimentação registrada para este cliente.
    </div>
}

<div class="mt-3">
    <a asp-action="Edit" asp-route-id="@Model?.Id" class="btn btn-warning">Editar Cliente</a> |
    <a asp-action="Index" class="btn btn-secondary">Voltar para Lista</a>
</div>